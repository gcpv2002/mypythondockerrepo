# .azure-pipelines.yml
name: $(date:yyyyMMdd)$(rev:.r)

trigger: none

variables:
  # Service connection / resource identifiers - set these in pipeline variables or replace here
  azureSubscriptionEndpoint: '222211d0-c114-439a-8826-2d7498d57072'
  acrJson: '{"loginServer":"mycontainerfordevops.azurecr.io", "id" : "/subscriptions/309f0051-440e-4163-ba9d-1d1f2bb6bf5d/resourceGroups/devops/providers/Microsoft.ContainerRegistry/registries/mycontainerfordevops"}'
  imageName: 'mycontainerfordevops.azurecr.io/azuredevopsfirstpush:$(Build.BuildId)'
  artifactName: 'drop'

  # AKS / ACR runtime settings - set these to your values (or create pipeline variables)
  RESOURCE_GROUP: 'devops'            # <-- replace in pipeline variables
  AKS_CLUSTER: 'aksfordevops'          # <-- replace in pipeline variables
  NAMESPACE: 'default'                   # namespace to apply the manifest into

stages:
- stage: Build
  displayName: Build and push image
  jobs:
  - job: Job_1
    displayName: Agent job 1
    pool:
      name: Default
    steps:
    - checkout: self
      clean: true
      fetchTags: false

    - task: Docker@0
      displayName: Build an image
      inputs:
        azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
        azureContainerRegistry: '$(acrJson)'
        imageName: '$(imageName)'
        qualifyImageName: false
        includeLatestTag: true

    - task: Docker@0
      displayName: Push an image
      inputs:
        azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
        azureContainerRegistry: '$(acrJson)'
        action: 'Push an image'
        imageName: '$(imageName)'
        qualifyImageName: false
        includeLatestTag: true

    - task: CopyFiles@2
      displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        Contents: azure-aks.yaml
        TargetFolder: $(Build.ArtifactStagingDirectory)

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Artifact: $(artifactName)'
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: '$(artifactName)'
        publishLocation: 'pipeline'

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: Deploy_Job
    displayName: Agent job - Deploy
    pool:
      name: Default
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download artifact: $(artifactName)'
      inputs:
        artifact: '$(artifactName)'
        path: '$(Pipeline.Workspace)'

    - task: AzureCLI@2
      displayName: 'Azure CLI: get AKS creds, show manifest and kubectl apply'
      inputs:
        azureSubscription: $(azureSubscriptionEndpoint)
        scriptType: bash
        scriptLocation: inlineScript
        failOnStandardError: true
        inlineScript: |
          set -euo pipefail

          ARTIFACT_DIR="$(Pipeline.Workspace)/$(artifactName)"
          MANIFEST="$ARTIFACT_DIR/azure-aks.yaml"

          echo "Pipeline workspace: $(Pipeline.Workspace)"
          echo "Listing artifact directory: $ARTIFACT_DIR"
          ls -la "$ARTIFACT_DIR" || true

          if [ ! -f "$MANIFEST" ]; then
            echo "ERROR: manifest not found at path: $MANIFEST"
            exit 2
          fi

          echo "----- Manifest ($MANIFEST) -----"
          sed -n '1,200p' "$MANIFEST" || true
          echo "----- end manifest -----"

          echo "Getting AKS credentials for cluster '${AKS_CLUSTER}' in resource group '${RESOURCE_GROUP}'"
          az aks get-credentials --resource-group "${RESOURCE_GROUP}" --name "${AKS_CLUSTER}" --overwrite-existing

          echo "kubectl context:"
          kubectl config current-context || true
          kubectl cluster-info || true

          echo "Applying manifest"
          kubectl apply -f "$MANIFEST" --namespace "${NAMESPACE}"

          echo "Listing resources in namespace ${NAMESPACE}"
          kubectl get all -n "${NAMESPACE}" -o wide || true